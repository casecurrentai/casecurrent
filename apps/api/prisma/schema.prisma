// CaseCurrent Database Schema
// All tables are scoped by org_id for multi-tenancy

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id                    String    @id @default(uuid())
  name                  String
  slug                  String    @unique
  status                String    @default("active")
  timezone              String    @default("America/New_York")
  onboardingStatus      String    @default("not_started") @map("onboarding_status") // not_started, in_progress, complete
  onboardingCompletedAt DateTime? @map("onboarding_completed_at")
  subscriptionStatus    String    @default("manual") @map("subscription_status") // trial, active, past_due, canceled, manual
  planTier              String?   @map("plan_tier") // core, pro, elite
  primaryPhoneNumberId  String?   @map("primary_phone_number_id")
  onCallUserId          String?   @map("on_call_user_id") // User designated to receive incoming call notifications
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  users                      User[]
  contacts                   Contact[]
  practiceAreas              PracticeArea[]
  aiConfig                   AiConfig?
  settings                   OrgSettings?
  intakeQuestionSets         IntakeQuestionSet[]
  phoneNumbers               PhoneNumber[]
  leads                      Lead[]
  interactions               Interaction[]
  calls                      Call[]
  messages                   Message[]
  intakes                    Intake[]
  qualifications             Qualification[]
  tasks                      Task[]
  notifications              Notification[]
  outgoingWebhookEndpoints   OutgoingWebhookEndpoint[]
  outgoingWebhookDeliveries  OutgoingWebhookDelivery[]
  auditLogs                  AuditLog[]
  userInvites                UserInvite[]
  orgHealthSnapshots         OrgHealthSnapshot[]
  experiments                Experiment[]
  policyTestSuites           PolicyTestSuite[]
  followupSequences          FollowupSequence[]

  @@map("organizations")
}

model User {
  id            String    @id @default(uuid())
  orgId         String    @map("org_id")
  email         String
  name          String
  role          String    @default("staff")
  status        String    @default("active")
  passwordHash  String    @map("password_hash")
  intakeEnabled Boolean   @default(true) @map("intake_enabled")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  organization   Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tasks          Task[]
  notifications  Notification[]
  auditLogs      AuditLog[]
  ownedLeads     Lead[]         @relation("LeadOwner")
  deviceTokens   DeviceToken[]
  appointments   Appointment[]
  onCallPhoneNumbers PhoneNumber[] @relation("PhoneNumberOnCall")

  @@unique([orgId, email])
  @@map("users")
}

// ============================================
// USER INVITES (for concierge onboarding)
// ============================================

model UserInvite {
  id         String    @id @default(uuid())
  orgId      String    @map("org_id")
  email      String
  role       String    @default("owner")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("user_invites")
}

// ============================================
// ORG HEALTH SNAPSHOTS (for platform admin monitoring)
// ============================================

model OrgHealthSnapshot {
  id         String   @id @default(uuid())
  orgId      String   @map("org_id")
  snapshotAt DateTime @map("snapshot_at")
  metrics    Json     // {leads_24h, calls_24h, messages_24h, webhook_failures_24h, jobs_pending, jobs_failed_24h}
  createdAt  DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("org_health_snapshots")
}

// ============================================
// CONTACTS & LEADS
// ============================================

model Contact {
  id           String   @id @default(uuid())
  orgId        String   @map("org_id")
  name         String
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  primaryPhone String?  @map("primary_phone")
  primaryEmail String?  @map("primary_email")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  leads        Lead[]

  @@map("contacts")
}

model PracticeArea {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization       Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  intakeQuestionSets IntakeQuestionSet[]
  leads              Lead[]
  intakes            Intake[]

  @@map("practice_areas")
}

model Lead {
  id                    String    @id @default(uuid())
  orgId                 String    @map("org_id")
  contactId             String    @map("contact_id")
  source                String
  status                String    @default("new")
  priority              String    @default("medium")
  displayName           String?   @map("display_name")
  practiceAreaId        String?   @map("practice_area_id")
  incidentDate          DateTime? @map("incident_date")
  incidentLocation      String?   @map("incident_location")
  summary               String?
  score                 Int?      @default(0)
  scoreLabel            String?   @map("score_label")
  scoreReasons          Json?     @map("score_reasons")
  urgency               String?   @default("normal")
  intakeData            Json?     @map("intake_data")
  ownerUserId           String?   @map("owner_user_id")
  nextStep              String?   @map("next_step")
  dnc                   Boolean   @default(false)
  dncReason             String?   @map("dnc_reason")
  dncAt                 DateTime? @map("dnc_at")
  lastActivityAt        DateTime? @map("last_activity_at")
  lastHumanResponseAt   DateTime? @map("last_human_response_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  organization   Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact        Contact         @relation(fields: [contactId], references: [id], onDelete: Cascade)
  practiceArea   PracticeArea?   @relation(fields: [practiceAreaId], references: [id])
  ownerUser      User?           @relation("LeadOwner", fields: [ownerUserId], references: [id])
  interactions   Interaction[]
  calls          Call[]
  messages       Message[]
  intake         Intake?
  qualification  Qualification?
  tasks          Task[]
  notifications  Notification[]
  portalTokens   LeadPortalToken[]
  appointments   Appointment[]

  @@map("leads")
}

// ============================================
// AI CONFIGURATION
// ============================================

model AiConfig {
  id                 String   @id @default(uuid())
  orgId              String   @unique @map("org_id")
  voiceGreeting      String?  @map("voice_greeting")
  disclaimerText     String?  @map("disclaimer_text")
  toneProfile        Json?    @map("tone_profile")
  handoffRules       Json?    @map("handoff_rules")
  qualificationRules Json?    @map("qualification_rules")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("ai_configs")
}

model IntakeQuestionSet {
  id             String   @id @default(uuid())
  orgId          String   @map("org_id")
  practiceAreaId String?  @map("practice_area_id")
  name           String
  version        Int      @default(1)
  schema         Json
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  practiceArea PracticeArea? @relation(fields: [practiceAreaId], references: [id])
  intakes      Intake[]

  @@map("intake_question_sets")
}

// ============================================
// TELEPHONY
// ============================================

model PhoneNumber {
  id               String   @id @default(uuid())
  orgId            String   @map("org_id")
  label            String
  e164             String   @unique
  provider         String
  providerSid      String?  @map("provider_sid")
  inboundEnabled   Boolean  @default(true) @map("inbound_enabled")
  afterHoursEnabled Boolean @default(false) @map("after_hours_enabled")
  onCallUserId     String?  @map("on_call_user_id")
  routing          Json?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  onCallUser   User?        @relation("PhoneNumberOnCall", fields: [onCallUserId], references: [id])
  calls        Call[]

  @@map("phone_numbers")
}

// ============================================
// INTERACTIONS, CALLS, MESSAGES
// ============================================

model Interaction {
  id        String    @id @default(uuid())
  orgId     String    @map("org_id")
  leadId    String    @map("lead_id")
  channel   String    // call, sms, webchat
  status    String    @default("active")
  startedAt DateTime  @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  metadata  Json?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  call         Call?
  messages     Message[]

  @@map("interactions")
}

model Call {
  id              String    @id @default(uuid())
  orgId           String    @map("org_id")
  leadId          String    @map("lead_id")
  interactionId   String    @unique @map("interaction_id")
  phoneNumberId   String    @map("phone_number_id")
  direction       String    // inbound, outbound
  provider        String
  providerCallId  String?   @unique @map("provider_call_id") // OpenAI call_id (set when OpenAI webhook arrives)
  twilioCallSid   String?   @unique @map("twilio_call_sid")  // Twilio CallSid (set when Twilio webhook arrives)
  fromE164        String    @map("from_e164")
  toE164          String    @map("to_e164")
  startedAt       DateTime  @map("started_at")
  endedAt         DateTime? @map("ended_at")
  durationSeconds Int?      @map("duration_seconds")
  callOutcome     String?   @map("call_outcome") // connected, voicemail, no-answer, busy, failed
  recordingUrl    String?   @map("recording_url")
  transcriptText  String?   @map("transcript_text")
  transcriptJson  Json?     @map("transcript_json")
  aiSummary       String?   @map("ai_summary")
  aiFlags         Json?     @map("ai_flags")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  interaction  Interaction  @relation(fields: [interactionId], references: [id], onDelete: Cascade)
  phoneNumber  PhoneNumber  @relation(fields: [phoneNumberId], references: [id])

  @@map("calls")
}

model Message {
  id                String   @id @default(uuid())
  orgId             String   @map("org_id")
  leadId            String   @map("lead_id")
  interactionId     String   @map("interaction_id")
  direction         String   // inbound, outbound
  channel           String   // sms, webchat
  provider          String
  providerMessageId String?  @map("provider_message_id")
  from              String
  to                String
  body              String
  createdAt         DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  interaction  Interaction  @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// ============================================
// INTAKE & QUALIFICATION
// ============================================

model Intake {
  id               String    @id @default(uuid())
  orgId            String    @map("org_id")
  leadId           String    @unique @map("lead_id")
  practiceAreaId   String?   @map("practice_area_id")
  questionSetId    String?   @map("question_set_id")
  answers          Json?
  completionStatus String    @default("partial") @map("completion_status")
  completedAt      DateTime? @map("completed_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lead         Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)
  practiceArea PracticeArea?      @relation(fields: [practiceAreaId], references: [id])
  questionSet  IntakeQuestionSet? @relation(fields: [questionSetId], references: [id])

  @@map("intakes")
}

model Qualification {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  leadId      String   @unique @map("lead_id")
  score       Int      @default(0) // 0-100
  disposition String   @default("review") // accept, review, decline
  reasons     Json?    // DecisionTrace structure
  confidence  Int      @default(0) // 0-100
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("qualifications")
}

// ============================================
// TASKS & NOTIFICATIONS
// ============================================

model Task {
  id             String    @id @default(uuid())
  orgId          String    @map("org_id")
  leadId         String    @map("lead_id")
  assignedUserId String?   @map("assigned_user_id")
  type           String
  status         String    @default("pending")
  dueAt          DateTime? @map("due_at")
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedUser User?        @relation(fields: [assignedUserId], references: [id])

  @@map("tasks")
}

model Notification {
  id        String    @id @default(uuid())
  orgId     String    @map("org_id")
  userId    String    @map("user_id")
  leadId    String?   @map("lead_id")
  type      String
  title     String
  body      String
  channels  String[]
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead         Lead?        @relation(fields: [leadId], references: [id])

  @@map("notifications")
}

// ============================================
// WEBHOOKS
// ============================================

model OutgoingWebhookEndpoint {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  url       String
  secret    String
  events    String[]
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deliveries   OutgoingWebhookDelivery[]

  @@map("outgoing_webhook_endpoints")
}

model OutgoingWebhookDelivery {
  id            String    @id @default(uuid())
  orgId         String    @map("org_id")
  endpointId    String    @map("endpoint_id")
  eventType     String    @map("event_type")
  payload       Json
  status        String    @default("pending")
  attemptCount  Int       @default(0) @map("attempt_count")
  lastAttemptAt DateTime? @map("last_attempt_at")
  responseCode  Int?      @map("response_code")
  responseBody  String?   @map("response_body")
  createdAt     DateTime  @default(now()) @map("created_at")

  organization Organization            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  endpoint     OutgoingWebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@map("outgoing_webhook_deliveries")
}

// ============================================
// MARKETING
// ============================================

model MarketingContactSubmission {
  id        String   @id @default(uuid())
  orgId     String?  @map("org_id")
  name      String
  email     String
  firm      String?
  message   String
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("marketing_contact_submissions")
}

model MarketingSubmission {
  id                   String   @id @default(uuid())
  type                 String   // 'contact' | 'demo'
  name                 String
  email                String
  firm                 String?
  phone                String?
  practiceArea         String?  @map("practice_area")
  currentIntakeMethod  String?  @map("current_intake_method")
  monthlyLeadVolume    String?  @map("monthly_lead_volume")
  message              String?
  metadata             Json?
  createdAt            DateTime @default(now()) @map("created_at")

  @@map("marketing_submissions")
}

// ============================================
// EXPERIMENTS (A/B Testing - Conversion Lab)
// ============================================

model Experiment {
  id           String    @id @default(uuid())
  orgId        String    @map("org_id")
  name         String
  description  String?
  kind         String    // intake_script, qualification_rules, follow_up_timing
  status       String    @default("draft") // draft, running, paused, ended
  config       Json      // variant definitions, weights, etc.
  startedAt    DateTime? @map("started_at")
  pausedAt     DateTime? @map("paused_at")
  endedAt      DateTime? @map("ended_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  organization Organization              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignments  ExperimentAssignment[]
  metricsDaily ExperimentMetricsDaily[]

  @@map("experiments")
}

model ExperimentAssignment {
  id           String   @id @default(uuid())
  orgId        String   @map("org_id")
  experimentId String   @map("experiment_id")
  leadId       String   @map("lead_id")
  variant      String   // control, variant_a, variant_b, etc.
  assignedAt   DateTime @default(now()) @map("assigned_at")

  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@unique([experimentId, leadId])
  @@map("experiment_assignments")
}

model ExperimentMetricsDaily {
  id           String   @id @default(uuid())
  orgId        String   @map("org_id")
  experimentId String   @map("experiment_id")
  variant      String
  date         DateTime @db.Date
  leads        Int      @default(0)
  conversions  Int      @default(0)
  avgScore     Float?   @map("avg_score")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@unique([experimentId, variant, date])
  @@map("experiment_metrics_daily")
}

// ============================================
// POLICY TESTS (Compliance Regression)
// ============================================

model PolicyTestSuite {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  name        String
  description String?
  testCases   Json     // array of test case definitions
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  runs         PolicyTestRun[]

  @@map("policy_test_suites")
}

model PolicyTestRun {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  suiteId   String   @map("suite_id")
  status    String   @default("running") // running, passed, failed
  results   Json     // array of test results
  summary   Json?    // passed_count, failed_count, etc.
  startedAt DateTime @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")

  suite PolicyTestSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  @@map("policy_test_runs")
}

// ============================================
// FOLLOW-UP SEQUENCES
// ============================================

model FollowupSequence {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  name        String
  description String?
  trigger     String   // lead_created, intake_completed, qualification_review
  steps       Json     // array of steps: {delayMinutes, channel, templateBody}
  stopRules   Json?    @map("stop_rules") // conditions to cancel remaining steps
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jobs         FollowupJob[]

  @@map("followup_sequences")
}

model FollowupJob {
  id           String    @id @default(uuid())
  orgId        String    @map("org_id")
  sequenceId   String    @map("sequence_id")
  leadId       String    @map("lead_id")
  stepIndex    Int       @map("step_index")
  scheduledAt  DateTime  @map("scheduled_at")
  status       String    @default("pending") // pending, sent, cancelled, failed
  sentAt       DateTime? @map("sent_at")
  cancelReason String?   @map("cancel_reason")
  createdAt    DateTime  @default(now()) @map("created_at")

  sequence FollowupSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@map("followup_jobs")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  actorUserId String?  @map("actor_user_id")
  actorType   String   @map("actor_type") // user, system, ai
  action      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  details     Json?
  createdAt   DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actorUser    User?        @relation(fields: [actorUserId], references: [id])

  @@map("audit_logs")
}

// ============================================
// ANALYTICS EVENTS (unified event store)
// ============================================

model AnalyticsEvent {
  id             String   @id @default(uuid())
  orgId          String   @map("org_id")
  userId         String?  @map("user_id")
  leadId         String?  @map("lead_id")
  practiceAreaId String?  @map("practice_area_id")
  type           String   // lead.created, lead.updated, call.incoming, call.completed, sms.sent, sms.received, intake.link_generated, experiment.exposure, experiment.conversion
  payload        Json     // event-specific data
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([orgId, createdAt])
  @@index([orgId, type])
  @@index([orgId, type, createdAt])
  @@index([orgId, leadId])
  @@index([orgId, practiceAreaId, createdAt])
  @@map("analytics_events")
}

// ============================================
// WEBHOOK RECEIPT (for idempotency)
// ============================================

model WebhookReceipt {
  id          String   @id @default(uuid())
  webhookId   String   @unique @map("webhook_id") // Standard Webhooks webhook-id header
  source      String   // "openai", "twilio", etc.
  eventType   String   @map("event_type")
  processedAt DateTime @default(now()) @map("processed_at")

  @@index([source, webhookId])
  @@map("webhook_receipts")
}

// ============================================
// DEVICE TOKENS (for push notifications)
// ============================================

model DeviceToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  orgId       String   @map("org_id")
  platform    String   // ios, android
  token       String
  deviceId    String   @map("device_id")
  active      Boolean  @default(true)
  preferences Json?    // {hotLeads: true, inboundSms: true, slaBreaches: true, privacyMode: false}
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@map("device_tokens")
}

// ============================================
// LEAD PORTAL TOKENS (secure intake/schedule links)
// ============================================

model LeadPortalToken {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  leadId    String   @map("lead_id")
  token     String   @unique
  purpose   String   // intake, schedule
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("lead_portal_tokens")
}

// ============================================
// APPOINTMENTS (scheduling)
// ============================================

model Appointment {
  id             String    @id @default(uuid())
  orgId          String    @map("org_id")
  leadId         String    @map("lead_id")
  assignedUserId String?   @map("assigned_user_id")
  startAt        DateTime  @map("start_at")
  endAt          DateTime  @map("end_at")
  timezone       String
  status         String    @default("booked") // booked, cancelled, completed
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  lead         Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedUser User? @relation(fields: [assignedUserId], references: [id])

  @@map("appointments")
}

// ============================================
// ORG SETTINGS (automation config)
// ============================================

model OrgSettings {
  id                        String   @id @default(uuid())
  orgId                     String   @unique @map("org_id")
  quietHoursStart           String   @default("22:00") @map("quiet_hours_start")
  quietHoursEnd             String   @default("08:00") @map("quiet_hours_end")
  overnightOutreachEnabled  Boolean  @default(false) @map("overnight_outreach_enabled")
  afterHoursOutreachEnabled Boolean  @default(true) @map("after_hours_outreach_enabled")
  autoSmsEnabled            Boolean  @default(true) @map("auto_sms_enabled")
  schedulingEnabled         Boolean  @default(true) @map("scheduling_enabled")
  slaBreachMinutes          Int      @default(15) @map("sla_breach_minutes")
  hotLeadScoreThreshold     Int      @default(70) @map("hot_lead_score_threshold")
  smsTemplate1              String?  @map("sms_template_1")
  smsTemplate2              String?  @map("sms_template_2")
  smsTemplate3              String?  @map("sms_template_3")
  smsTemplate4              String?  @map("sms_template_4")
  slotLengthMinutes         Int      @default(20) @map("slot_length_minutes")
  bufferMinutes             Int      @default(5) @map("buffer_minutes")
  scheduleDaysAhead         Int      @default(7) @map("schedule_days_ahead")
  businessHoursJson         Json?    @map("business_hours_json")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("org_settings")
}

// ============================================
// OUTBOUND MESSAGE QUEUE
// ============================================

model OutboundMessage {
  id           String    @id @default(uuid())
  orgId        String    @map("org_id")
  leadId       String    @map("lead_id")
  toPhone      String    @map("to_phone")
  body         String
  channel      String    @default("sms")
  provider     String    @default("twilio")
  status       String    @default("queued") // queued, sending, sent, failed, cancelled, suppressed
  sendAt       DateTime  @map("send_at")
  sentAt       DateTime? @map("sent_at")
  attemptCount Int       @default(0) @map("attempt_count")
  lastError    String?   @map("last_error")
  ruleId       String?   @map("rule_id")
  reason       String?
  providerId   String?   @map("provider_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([status, sendAt])
  @@map("outbound_messages")
}
